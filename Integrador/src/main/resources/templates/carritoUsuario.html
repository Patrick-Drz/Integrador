<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Carrito</title>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-4Q6Gf2aSP4eDXB8Miphtr37CMZZQ5oXLH2yaXMJ2w8e2ZtHTl7GptT4jmndRuHDT" crossorigin="anonymous">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A==" crossorigin="anonymous" referrerpolicy="no-referrer" />
        <link rel="stylesheet" href="/style.css">
    </head>
    <body>
        <div th:replace="~{navbarUser :: userNavbar}"></div>

        <div class="container carrito-container">
            <div class="carrito-header">
                <h2><i class="fa-solid fa-cart-shopping"></i> Mi Carrito de Compras</h2>
            </div>

            <div th:if="${successMessage}" class="alert alert-success alert-dismissible fade show" role="alert">
                <span th:text="${successMessage}"></span>
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
            <div th:if="${errorMessage}" class="alert alert-danger alert-dismissible fade show" role="alert">
                <span th:text="${errorMessage}"></span>
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
            <div th:if="${infoMessage}" class="alert alert-info alert-dismissible fade show" role="alert">
                <span th:text="${infoMessage}"></span>
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>

            <div th:if="${user != null}" class="user-info mt-3 p-3 border rounded bg-light">
                <h4><i class="fa-solid fa-user"></i> Datos del Usuario</h4>
                <p><strong>Nombre Completo:</strong> <span th:text="${user.nombreCompleto}"></span></p>
                <p><strong>Código de Estudiante:</strong> <span th:text="${user.codigoEstudiante}"></span></p>
            </div>
            <hr>
            <div class="ubicacion-info mt-4">
                <h4><i class="fa-solid fa-location-dot"></i> Mi Ubicación de Entrega</h4>
                <div th:if="${ubicacionUsuario != null}">
                    <p><strong>Piso:</strong> <span th:text="${ubicacionUsuario.piso}"></span></p>
                    <p><strong>Código de Aula:</strong> <span th:text="${ubicacionUsuario.codigoAula}"></span></p>
                </div>
                <div th:unless="${ubicacionUsuario != null}">
                    <p class="text-danger">Aún no tienes una ubicación de entrega registrada. ¡Por favor, añade una para continuar con tu compra!</p>
                    <a th:href="@{/user/aula}" class="btn btn-outline-primary btn-sm"><i class="fa-solid fa-map-marker-alt"></i> Añadir Ubicación</a>
                </div>
            </div>
            <hr>
            <div th:if="${carrito != null and not #lists.isEmpty(carrito.items)}">
                <h4>Ítems en tu carrito:</h4>
                <div th:each="item : ${carrito.items}" class="carrito-item">
                    <div class="item-details">
                        <h5 th:if="${item.producto != null}" th:text="${item.producto.nombre}">Nombre del Producto</h5>
                        <h5 th:if="${item.oferta != null}" th:text="${item.oferta.nombreOferta}">Nombre de la Oferta</h5>
                        <p>Precio Unitario: S/. <span th:text="${#numbers.formatDecimal(item.precioUnitarioAlMomento, 1, 2)}">0.00</span></p>
                    </div>
                    <div class="item-controls">
                        <form class="d-flex align-items-center me-2 update-quantity-form">
                            <input type="hidden" name="itemId" th:value="${item.id}" />
                            <label th:for="${'quantity_' + item.id}" class="form-label mb-0 me-2">Cantidad:</label>
                            <input type="number" th:id="${'quantity_' + item.id}" name="quantity" th:value="${item.cantidad}" min="1" class="form-control form-control-sm"/>
                            <button type="submit" class="btn btn-primary btn-sm ms-2" title="Actualizar cantidad"><i class="fa-solid fa-arrows-rotate"></i></button>
                        </form>
                        <form class="remove-item-form">
                            <input type="hidden" name="itemId" th:value="${item.id}" />
                            <button type="submit" class="btn btn-danger btn-sm" title="Eliminar ítem"><i class="fa-solid fa-trash-can"></i></button>
                        </form>
                    </div>
                    <div class="item-price">
                        S/. <span th:text="${#numbers.formatDecimal(item.precioUnitarioAlMomento * item.cantidad, 1, 2)}">0.00</span>
                    </div>
                </div>
                <div class="carrito-summary text-end">
                    <p class="carrito-total">Total: S/. <span th:text="${#numbers.formatDecimal(totalCarrito, 1, 2)}">0.00</span></p>
                    <form id="procesarPagoForm">
                        <button type="submit" class="btn btn-success btn-lg" id="procesarPagoBtn" th:disabled="${ubicacionUsuario == null}">
                            <i class="fa-solid fa-cash-register"></i> Proceder al Pago
                        </button>
                    </form>
                </div>
            </div>
            <div th:unless="${carrito != null and not #lists.isEmpty(carrito.items)}" class="alert alert-info text-center mt-5">
                <p><i class="fa-solid fa-triangle-exclamation"></i> Tu carrito está vacío. ¡Añade algunos productos o ofertas!</p>
                <a th:href="@{/user/compra}" class="btn btn-primary mt-3"><i class="fa-solid fa-plus-circle"></i> Ir a Comprar</a>
            </div>
        </div>

        <div id="myModal" class="modal modal-hidden">
            <div class="modal-content">
                <span class="close-button">&times;</span>
                <p id="modalMessage"></p>
                <button id="modalActionButton" class="modal-button">OK</button>
            </div>
        </div>

        <div class="modal fade" id="logoutModal" tabindex="-1" aria-labelledby="logoutModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="logoutModalLabel">Confirmar Cierre de Sesión</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        ¿Estás seguro de que deseas cerrar tu sesión?
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <a th:href="@{/logout}" class="btn btn-danger">Aceptar</a>
                    </div>
                </div>
            </div>
        </div>

        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/js/bootstrap.bundle.min.js"></script>
        <script src="/script.js"></script> <script>
            document.addEventListener('DOMContentLoaded', () => {
                // Contenedor principal del carrito que se va a refrescar
                const carritoContainer = document.querySelector('.carrito-container');

                // Función para recargar el contenido del carrito usando el fragmento
                async function fetchAndRenderCarrito() {
                    try {
                        const response = await fetch('/user/carrito-fragment');
                        const html = await response.text();
                        if (response.ok) {
                            carritoContainer.innerHTML = html;
                            // Después de refrescar, volvemos a añadir los listeners a los nuevos botones
                            addEventListenersToForms();
                        } else {
                            console.error('Error al refrescar el fragmento del carrito. Estado:', response.status);
                        }
                    } catch (error) {
                        console.error('Error de red al refrescar el carrito:', error);
                    }
                }

                // Función para añadir los listeners a todos los formularios del carrito
                function addEventListenersToForms() {
                    // Listener para actualizar cantidad
                    document.querySelectorAll('.update-quantity-form').forEach(form => {
                        form.addEventListener('submit', async (event) => {
                            event.preventDefault();
                            const formData = new FormData(form);
                            const params = new URLSearchParams(formData);

                            try {
                                const response = await fetch('/user/carrito/update', {
                                    method: 'POST',
                                    body: params
                                });
                                const data = await response.json();
                                if (data.success) {
                                    await fetchAndRenderCarrito();
                                } else {
                                    // Si quieres mostrar el error en el modal, descomenta la siguiente línea
                                    // showModal(data.message, false, data.redirectUrl);
                                    console.error("Error al actualizar:", data.message);
                                }
                            } catch (error) {
                                console.error('Error en la solicitud para actualizar item:', error);
                            }
                        });
                    });

                    // Listener para eliminar item
                    document.querySelectorAll('.remove-item-form').forEach(form => {
                        form.addEventListener('submit', async (event) => {
                            event.preventDefault();
                            if (!confirm('¿Estás seguro de que quieres eliminar este ítem?')) {
                                return;
                            }
                            const formData = new FormData(form);
                            const params = new URLSearchParams(formData);

                            try {
                                const response = await fetch('/user/carrito/remove', {
                                    method: 'POST',
                                    body: params
                                });
                                const data = await response.json();
                                if (data.success) {
                                    await fetchAndRenderCarrito();
                                } else {
                                    // showModal(data.message, false, data.redirectUrl);
                                    console.error("Error al eliminar:", data.message);
                                }
                            } catch (error) {
                                console.error('Error en la solicitud para eliminar item:', error);
                            }
                        });
                    });

                    // Listener para el formulario de pago
                    const procesarPagoForm = document.getElementById('procesarPagoForm');
                    if (procesarPagoForm) {
                        procesarPagoForm.addEventListener('submit', async (event) => {
                            event.preventDefault();
                            const procesarPagoBtn = document.getElementById('procesarPagoBtn');
                            procesarPagoBtn.disabled = true;
                            procesarPagoBtn.textContent = 'Procesando...';

                            try {
                                const response = await fetch('/user/carrito/procesarPagoAjax', {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/x-www-form-urlencoded',
                                    },
                                });

                                const data = await response.json();
                                if (data.success) {
                                    // Pago exitoso, refrescamos el carrito que ahora estará vacío
                                    await fetchAndRenderCarrito();
                                    // Y mostramos el mensaje de éxito
                                    showModal(data.message, true, null);
                                } else {
                                    showModal(data.message, false, data.redirectUrl);
                                }
                            } catch (error) {
                                console.error('Error durante el procesamiento del pago AJAX:', error);
                                showModal('Hubo un error al procesar tu solicitud de pago. Inténtalo de nuevo.', false, null);
                            } finally {
                                // El botón de pago ya no existirá si el carrito se vació,
                                // así que no necesitamos reactivarlo. Si hubo un error, se reactivará
                                // la próxima vez que se refresque el fragmento.
                            }
                        });
                    }
                }

                // Añadir los listeners por primera vez al cargar la página
                addEventListenersToForms();
            });
        </script>
    </body>
</html>
